<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ホーム - Futoru</title>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div th:replace="~{common/navbar :: navbar('home')}"></div>

<div class="container py-4">
    <div class="row mb-4">

        <div class="col-md-7 mb-3">
            <div class="dashboard-card h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">体重推移</h5>
                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill"
                            data-bs-toggle="modal" data-bs-target="#weightModal">
                        <i class="bi bi-plus-lg"></i> 今日の体重を記録
                    </button>
                </div>
                <div style="height: 250px;">
                    <canvas id="weightChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-5 mb-3">
            <div class="dashboard-card text-center d-flex flex-column justify-content-center h-100">
                <h2 class="fw-bold display-4 mb-0">
                    <span id="targetCalories" th:text="${dashboard.targetCalories}">2500</span> <span class="fs-4">kcal</span>
                </h2>
                <p class="text-muted small">目標カロリー</p>

                <p class="fw-bold mt-3 mb-1">
                    摂取カロリー
                    <span id="currentCalories" th:text="${dashboard.currentCalories}">0</span> kcal /
                    <span th:text="${dashboard.targetCalories}">2500</span> kcal
                </p>
                <div class="progress" style="height: 25px;">
                    <div id="progressBar" class="progress-bar bg-theme" role="progressbar"
                         th:style="'width: ' + ${progress} + '%'"
                         th:aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="dashboard-card">
                <h5 class="fw-bold mb-3">食事を記録</h5>

                <p class="small text-muted mb-2">記録方法を選択</p>
                <div class="d-flex flex-column gap-2 mb-4"> <button class="btn btn-theme w-100 py-2 fw-bold shadow-sm text-start ps-3"
                                                                    data-bs-toggle="modal" data-bs-target="#menuModal">
                    <i class="bi bi-list-ul me-2"></i>メニューから選択
                    <span class="float-end small fw-normal opacity-75">登録済み・レシピ</span>
                </button>

                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary flex-fill fw-bold shadow-sm"
                                data-bs-toggle="modal" data-bs-target="#manualInputModal">
                            <i class="bi bi-pencil me-1"></i>手動入力
                        </button>
                        <a th:href="@{/recipe/create}" class="btn btn-outline-success flex-fill fw-bold shadow-sm">
                            <i class="bi bi-plus-circle me-1"></i>レシピ作成
                        </a>
                    </div>
                </div>

                <div>
                    <h6 class="fw-bold text-muted border-bottom pb-2">今日の記録</h6>

                    <div id="mealHistoryList" class="list-group list-group-flush">
                        <div id="emptyHistoryMessage" th:if="${#lists.isEmpty(history)}" class="text-center py-3 text-muted small">
                            まだ記録がありません
                        </div>

                        <div th:each="log : ${history}" class="list-group-item px-0 d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-egg-fried text-theme me-2"></i>
                                <span class="fw-bold" th:text="${log.name}">食品名</span>
                                <span th:if="${log.amount != 1.0}" class="badge bg-secondary-subtle text-dark ms-1"
                                      th:text="'x' + ${log.amount}">x1.5</span>
                                <div class="small text-muted ms-4">
                                    <span th:text="${#temporals.format(log.eatenAt, 'HH:mm')}">12:00</span>
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="fw-bold me-3" th:text="${log.calories} + ' kcal'">300 kcal</span>
                                <button class="btn btn-link text-danger p-0 small text-decoration-none"
                                        th:onclick="'deleteFood(' + ${log.id} + ')'">
                                    <i class="bi bi-trash"></i> 削除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="weightModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px; overflow: hidden;">

            <div class="modal-header border-0 bg-theme text-white justify-content-center position-relative py-3">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-speedometer2 me-2"></i>体重を記録
                </h5>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 me-3"
                        data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form th:action="@{/weight/add}" method="post">
                <div class="modal-body p-4">

                    <div class="mb-4">
                        <label class="form-label text-muted small fw-bold d-block text-center mb-2">日付</label>
                        <div class="d-flex justify-content-center align-items-center gap-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="setDateOffset(-1)">昨日</button>
                            <input type="date" class="form-control form-control-lg text-center border-0 bg-light rounded-pill fw-bold"
                                   id="weightDate" name="date" style="max-width: 160px; font-size: 1rem;" required>
                            <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill px-3" onclick="setDateOffset(0)">今日</button>
                        </div>
                    </div>

                    <div class="mb-4 text-center">
                        <label for="weightInput" class="form-label text-muted small fw-bold">測定結果</label>
                        <div class="position-relative d-inline-block">
                            <input type="number" step="0.1" class="form-control border-0 text-center fw-bold p-0 m-0 w-100"
                                   id="weightInput" name="weight" placeholder="00.0"
                                   style="font-size: 4rem; height: auto; color: #333; background: transparent; box-shadow: none;" required>
                            <div style="height: 4px; width: 100px; background-color: var(--bs-primary); margin: 0 auto; border-radius: 2px; opacity: 0.5;"></div>
                        </div>
                        <span class="fs-4 text-muted fw-bold ms-2 align-baseline">kg</span>
                    </div>

                </div>

                <div class="modal-footer border-0 justify-content-center pb-4 pt-0">
                    <button type="submit" class="btn btn-theme px-5 py-2 rounded-pill fw-bold shadow-sm w-75">
                        <i class="bi bi-check-lg me-1"></i> 保存する
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="manualInputModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">手動で記録</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="manualInputForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="foodName" class="form-label text-muted small">食品名</label>
                        <input type="text" class="form-control" id="foodName" name="name" placeholder="例: おにぎり" required>
                    </div>
                    <div class="mb-3">
                        <label for="foodCalories" class="form-label text-muted small">カロリー (kcal)</label>
                        <input type="number" class="form-control" id="foodCalories" name="calories" placeholder="例: 200" required>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-theme px-4 fw-bold">記録する</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="menuModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable"> <div class="modal-content">
        <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">メニューから選択</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
            <input type="text" id="menuSearch" class="form-control mb-3" placeholder="メニューを検索...">

            <div class="d-grid mb-3">
                <a th:href="@{/recipe/create}" class="btn btn-outline-success border-dashed">
                    <i class="bi bi-plus-lg me-1"></i>新しいレシピ・セットを作る
                </a>
            </div>

            <hr class="text-muted">

            <div class="list-group list-group-flush" id="menuListContainer">
                <button th:each="food : ${foodList}"
                        type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-3 menu-item-btn"
                        th:onclick="'addFoodFromMenu(' + ${food.id} + ')'">
                        <span>
                            <i th:class="${food.type == 'DISH'} ? 'bi bi-basket2-fill text-warning me-2' : 'bi bi-egg-fried text-secondary me-2'"></i>
                            <span class="fw-bold menu-name" th:text="${food.name}">食品名</span>
                        </span>
                    <span class="badge bg-light text-dark border rounded-pill"
                          th:text="${food.calories} + ' kcal'">0 kcal</span>
                </button>

                <div th:if="${#lists.isEmpty(foodList)}" class="text-center py-4 text-muted">
                    メニューがありません。<br>上のボタンから作成してください。
                </div>
            </div>
        </div>
    </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0 shadow" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body fw-bold">
                <i class="bi bi-check-circle-fill me-2"></i>
                <span id="toastMessage">処理が完了しました</span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);

        // URLに ?success=true がある場合のみ実行
        if (urlParams.has('success')) {
            const toastEl = document.getElementById('successToast');

            if (toastEl) {
                document.getElementById('toastMessage').textContent = "レシピを作成しました！";

                // Bootstrap 5 の Toast を初期化して表示
                const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();

                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }
    });

    document.getElementById('weightDate').addEventListener('change', function() {
        if (this.value) fetchWeightData(this.value);
    });

    function fetchWeightData(dateStr) {
        const weightInput = document.getElementById('weightInput');
        weightInput.value = '';
        fetch(`/api/weight?date=${dateStr}`)
            .then(response => response.json())
            .then(data => {
                weightInput.value = (data.weight !== null) ? data.weight : '';
            });
    }
</script>

<script th:inline="javascript">
    const ctx = document.getElementById('weightChart').getContext('2d');
    const weightDates = /*[[${weightDates}]]*/ [];
    const weightValues = /*[[${weightValues}]]*/ [];

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: weightDates,
            datasets: [{
                label: '体重 (kg)',
                data: weightValues,
                borderColor: '#00B4D8',
                backgroundColor: 'rgba(0, 180, 216, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false, grace: '10%' } },
            plugins: { legend: { display: false } }
        }
    });
</script>

<script>
    // 日付操作用関数（昨日・今日ボタン用）
    function setDateOffset(offset) {
        const dateInput = document.getElementById('weightDate');
        const today = new Date();
        today.setDate(today.getDate() + offset);

        // YYYY-MM-DD形式に変換
        const yyyy = today.getFullYear();
        const mm =String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');

        const formattedDate = `${yyyy}-${mm}-${dd}`;

        dateInput.value = formattedDate;

        // 日付変更イベントを手動で発火させて、既存のデータ取得処理(fetchWeightData)を走らせる
        dateInput.dispatchEvent(new Event('change'));
    }

    // ページ読み込み時に初期値をセット（既存のロジックがあればマージしてください）
    document.addEventListener('DOMContentLoaded', function () {
        // もし日付が入っていなければ今日を入れる
        if(!document.getElementById('weightDate').value) {
            setDateOffset(0);
        }
    });
</script>

<script>
    // CSRFトークン取得用ヘルパー
    function getCsrfHeaders() {
        const tokenMeta = document.querySelector('meta[name="_csrf"]');
        const headerMeta = document.querySelector('meta[name="_csrf_header"]');
        if (tokenMeta && headerMeta) {
            return { [headerMeta.content]: tokenMeta.content };
        }
        return {};
    }

    // 画面更新ロジック
    function updateScreen(data) {
        // ダッシュボード更新
        document.getElementById('currentCalories').textContent = data.dashboard.currentCalories;
        const progressBar = document.getElementById('progressBar');
        progressBar.style.width = data.progress + '%';
        progressBar.setAttribute('aria-valuenow', data.progress);

        // リスト更新
        const listContainer = document.getElementById('mealHistoryList');
        const emptyMessage = document.getElementById('emptyHistoryMessage');

        // 既存のリストアイテム（class="list-group-item"を持つもの）だけ削除する
        // ※ emptyMessage は消さないように注意
        const items = listContainer.querySelectorAll('.list-group-item');
        items.forEach(item => item.remove());

        if (data.history.length === 0) {
            if(emptyMessage) emptyMessage.style.display = 'block';
        } else {
            if(emptyMessage) emptyMessage.style.display = 'none';

            data.history.forEach(log => {
                const date = new Date(log.eatenAt);
                const timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const amountBadge = log.amount !== 1.0 ? `<span class="badge bg-secondary-subtle text-dark ms-1">x${log.amount}</span>` : '';

                const itemHtml = `
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-egg-fried text-theme me-2"></i>
                            <span class="fw-bold">${log.name}</span>
                            ${amountBadge}
                            <div class="small text-muted ms-4">${timeStr}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="fw-bold me-3">${log.calories} kcal</span>
                            <button class="btn btn-link text-danger p-0 small text-decoration-none"
                                    onclick="deleteFood(${log.id})">
                                <i class="bi bi-trash"></i> 削除
                            </button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }
    }

    // メニューから追加
    function addFoodFromMenu(foodItemId) {
        const formData = new FormData();
        formData.append('foodItemId', foodItemId);
        formData.append('amount', 1.0);

        fetch('/api/food/add', {
            method: 'POST',
            body: formData,
            headers: getCsrfHeaders() // CSRFヘッダー付与
        })
            .then(res => res.json())
            .then(data => {
                updateScreen(data)

                const modalEl = document.getElementById('menuModal');
                // モーダルが開いている場合のみ閉じる処理を実行
                if (modalEl.classList.contains('show')) {
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if(modal) modal.hide();
                }

            });
    }

    document.getElementById('menuSearch').addEventListener('keyup', function() {
        const keyword = this.value.toLowerCase();
        const items = document.querySelectorAll('.menu-item-btn');

        items.forEach(item => {
            const name = item.querySelector('.menu-name').textContent.toLowerCase();
            if (name.includes(keyword)) {
                item.style.display = ''; // 表示
            } else {
                item.style.display = 'none'; // 非表示
            }
        });
    });

    // 手動入力フォーム送信
    document.getElementById('manualInputForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        fetch('/api/food/manual', {
            method: 'POST',
            body: formData,
            headers: getCsrfHeaders()
        })
            .then(res => res.json())
            .then(data => {
                updateScreen(data);
                const modal = bootstrap.Modal.getInstance(document.getElementById('manualInputModal'));
                modal.hide();
                this.reset();
            });
    });

    // 削除
    function deleteFood(id) {
        if (!confirm('削除しますか？')) return;

        fetch(`/api/food/delete/${id}`, {
            method: 'POST',
            headers: getCsrfHeaders()
        })
            .then(res => res.json())
            .then(data => updateScreen(data));
    }
</script>

</body>
</html>