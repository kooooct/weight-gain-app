<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>レシピ作成 - Futoru</title>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        /* 右側のカートエリアをスクロール追従させる */
        .sticky-sidebar {
            position: sticky;
            top: 20px;
        }
        .food-item-btn:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div th:replace="~{common/navbar :: navbar('recipe')}"></div>

<div class="container py-4">
    <div class="row">

        <div class="col-md-7 mb-4">
            <h4 class="fw-bold mb-3"><i class="bi bi-search me-2"></i>食材を選ぶ</h4>

            <input type="text" id="foodSearch" class="form-control form-control-lg mb-3" placeholder="食材名で検索...">

            <div class="list-group" id="foodListContainer">
                <button th:each="food : ${foodList}"
                        type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center food-item-btn"
                        th:onclick="addToRecipe([[${food.id}]], [[${food.name}]], [[${food.calories}]])">
                    <span class="food-name" th:text="${food.name}">食品名</span>
                    <span class="badge bg-light text-dark border rounded-pill"
                          th:text="${food.calories} + ' kcal'">100 kcal</span>
                </button>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card shadow-sm sticky-sidebar border-0 bg-light">
                <div class="card-body">
                    <h4 class="fw-bold mb-3 text-theme"><i class="bi bi-basket2 me-2"></i>作成中のレシピ</h4>

                    <div class="mb-3">
                        <label class="form-label small text-muted">レシピ名 (セット名)</label>
                        <input type="text" id="recipeName" class="form-control fw-bold" placeholder="例: カレーライス, 朝食セットA" required>
                    </div>

                    <hr>

                    <div id="selectedItemsArea" class="mb-3">
                        <p class="text-center text-muted small py-4" id="emptyMsg">
                            左のリストから食材を選んでください
                        </p>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="h5 mb-0">合計:</span>
                        <span class="h4 fw-bold text-theme mb-0"><span id="totalCalories">0</span> kcal</span>
                    </div>

                    <button class="btn btn-theme w-100 py-2 fw-bold rounded-pill" onclick="saveRecipe()">
                        <i class="bi bi-save me-2"></i>この内容で保存する
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 選ばれた食材を管理する配列
    let cart = []; // { id: 1, name: "豚肉", unitCalories: 200, amount: 1.0 }

    // 1. カートに追加する関数
    function addToRecipe(id, name, calories) {
        // すでにカートにあるかチェック
        const existing = cart.find(item => item.id === id);
        if (existing) {
            existing.amount += 1.0; // あれば+1する
        } else {
            cart.push({ id: id, name: name, unitCalories: calories, amount: 1.0 });
        }
        renderCart();
    }

    // 2. カートから削除する関数
    function removeFromRecipe(index) {
        cart.splice(index, 1);
        renderCart();
    }

    // 3. 量を変更した時に呼ばれる関数
    function updateAmount(index, newAmount) {
        cart[index].amount = parseFloat(newAmount);
        renderCart();
    }

    // 4. カートの中身を描画する関数 (一番重要！)
    function renderCart() {
        const container = document.getElementById('selectedItemsArea');
        const emptyMsg = document.getElementById('emptyMsg');
        const totalEl = document.getElementById('totalCalories');

        container.innerHTML = ''; // 一旦クリア
        let total = 0;

        if (cart.length === 0) {
            container.appendChild(emptyMsg); // 空っぽメッセージを戻す
            totalEl.textContent = 0;
            return;
        }

        cart.forEach((item, index) => {
            const subtotal = Math.round(item.unitCalories * item.amount);
            total += subtotal;

            const html = `
                <div class="bg-white p-2 rounded mb-2 shadow-sm border">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">${item.name}</span>
                        <button class="btn btn-sm text-danger p-0" onclick="removeFromRecipe(${index})">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="input-group input-group-sm" style="width: 120px;">
                            <input type="number" step="0.1" class="form-control" value="${item.amount}"
                                   onchange="updateAmount(${index}, this.value)">
                            <span class="input-group-text">人前</span>
                        </div>
                        <span class="small fw-bold text-muted">${subtotal} kcal</span>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });

        totalEl.textContent = total;
    }

    // 5. 保存処理 (AJAX)
    function saveRecipe() {
        const name = document.getElementById('recipeName').value;
        if (!name) {
            alert("レシピ名を入力してください");
            return;
        }
        if (cart.length === 0) {
            alert("食材を少なくとも1つ選んでください");
            return;
        }

        // 送信データ作成 (RecipeFormに合わせる)
        const requestData = {
            name: name,
            ingredients: cart.map(item => ({
                foodItemId: item.id,
                amount: item.amount
            }))
        };

        // CSRFトークン取得
        const token = document.querySelector('meta[name="_csrf"]').content;
        const header = document.querySelector('meta[name="_csrf_header"]').content;

        fetch('/recipe/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [header]: token // CSRFヘッダー
            },
            body: JSON.stringify(requestData)
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('レシピを保存しました！');
                    window.location.href = '/'; // ホームに戻る
                }
            })
            .catch(err => console.error(err));
    }

    // 6. 左側の検索フィルター機能
    document.getElementById('foodSearch').addEventListener('keyup', function() {
        const keyword = this.value.toLowerCase();
        const items = document.querySelectorAll('.food-item-btn');

        items.forEach(item => {
            const name = item.querySelector('.food-name').textContent.toLowerCase();
            if (name.includes(keyword)) {
                item.style.display = ''; // 表示
            } else {
                item.style.display = 'none'; // 非表示
            }
        });
    });
</script>

</body>
</html>